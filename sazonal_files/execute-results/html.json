{
  "hash": "9b0a5fba995d6e9ed8e03e06898c29a2",
  "result": {
    "markdown": "# Modelos lineares dinâmicos sazonais\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stderr}\n```\nCarregando pacotes exigidos: dlm\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'dlm' was built under R version 4.3.1\n```\n:::\n:::\n\n\n## A soma de um ciclo sazonal\n\nComo ilustração, considere um efeito sazonal trimestral (período 4). Considere os seguintes fatores sazonais:\n\n$$\\beta_t=\\left\\{\\begin{array}{ll}1,& t=1,5,9,\\ldots \\\\\n2,& t=2,6,10,\\ldots\\\\\n3,&t=3,7,11,\\ldots \\\\\n4,&t=4,8,12,\\ldots\\end{array}\\right.$$\n\nNote que \n$$\\beta_1+\\beta_2+\\beta_3+\\beta_4=10$$\n\nTambém note que\n$$\\beta_2+\\beta_3+\\beta_4+\\beta_5=10$$\ne que o mesmo é verdade para a soma de 4 quaiquer fatores sazonais consecutivos. Pode-se provar que, para qualquer sinal sazonal, a soma de seu efeito considerando um intervalo de tempo igual ao período é constante.\n\nConsidere então que uma série com período 4, fatores sazonais desconhecidos e e uma uma tendência, do tipo\n$$\\hbox{tendência}(t)=\\alpha+\\gamma t.$$\nEntão, para qualquer $k=0,1,2,\\ldots,$\n\n$$y_{k+1}+y_{k+2}+y_{k+3}+y_{k+4}=4\\alpha+\\gamma(10+4k)+\\beta_1+\\beta_2+\\beta_3+\\beta_4$$\n\nPortanto, se os dados forem agregados para construir uma série anual, é impossível estimar $\\alpha$ e $\\beta_1+\\beta_2+\\beta_3+\\beta_4$ em separado. Por isso, assuminos que a soma dos fatores sazonais deve ser nula. Intuitivamente, estamos dizendo que o nível da série não pode ser modelado pela tendência.\n\n## O modelo linear dinâmico para fatores sazonais\n\nConsidere uma série sazonal com período $p$. No modelo linear dinâmico para fatores sazonais, assumimos que existem $p-1$ fatores sazonais,\n\n$$\\psi_1,\\ldots,\\psi_{p-1},$$\nsendo que o $p$-ésimo fator é, necessariamente $-(\\psi_1-\\psi_2-\\cdots-\\psi_{p-1}$. Além disso, permitimos que cada fator evolua no tempo, o que implica na notação $\\psi_t$. Contudo, neste modelo consideramos apenas uma evolução de nível para os fatores (em um problema mensal, todos os janeiros estariam flutuando em torno de um nível, por exemplo). Por este motivo, a previsão para cada fator dentro dentro de uma determinada posição do ciclo sazonal será constante.\n\nA função `dlmModSeas` constrói as matrizes $F_t$ e $G_t$ para o modelo com fatores sazonais dinâmicos. Vamos ilustrar o uso deste modelo utilizando a série `nottem` - por didática, vamos remover a tendência da série via `loess`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntempo <- 1:length(nottem)\ndnottem <- nottem - loess( nottem ~ tempo)$fit\nts.plot(dnottem)\nabline(h=0,lty =2)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nJá identificamos, em outro momento, que o período desta série é 12, logo\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- dlmModSeas(12)\n```\n:::\n\n\nPrecisamos colocar uma informação sobre os fatores sazonais. Vamos simplesmente assumir que todos valem zero.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod$m0 <- rep(0,11)\n```\n:::\n\n\nVamos estimar as variâncias:\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- modFim(dnottem, mod)\n```\n:::\n\nEm seguida, aplicamos o filtro de Kalman e verificamos os erros de previsão:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfiltro <- dlmFilter(dnottem, mod)\n\nerro <- dnottem - filtro$f\nts.plot(erro)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\nacf(erro)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-6-2.png){width=672}\n:::\n:::\n\n\nPodemos notar que os erros foram altos no começo da série. Em geral, precisamos de pelos menos dois ciclos sazonais para ter uma previsão melhor. Já no correlograma, sobraram alguns elementos para serem explicados, como uma relação da série com as defasagens 1 e 2 e uma sazonalidade autoregressiva. Contudo, o comportamento sazonal, que era nosso objetivo, foi bem explicado.\n\nAs previsões vão se repetir após $12$ unidades de tempo. Abaixo, fazemos a previsão para 2 anos.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprevisao24 <- dlmForecast(filtro,24)\nprevisao24$f\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n             Jan         Feb         Mar         Apr         May         Jun\n1940  -9.5206529  -9.3739754  -6.5384935  -2.5977187   3.0850694   9.1938015\n1941  -9.5206529  -9.3739754  -6.5384935  -2.5977187   3.0850694   9.1938015\n             Jul         Aug         Sep         Oct         Nov         Dec\n1940  11.7308485  12.0444188   7.9602846  -0.4841747  -4.6829642 -10.8164433\n1941  11.7308485  12.0444188   7.9602846  -0.4841747  -4.6829642 -10.8164433\n```\n:::\n:::\n\n\nVamos colocar essas informações em um gráfico.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts.plot(dnottem,xlim=c(1920,1942), ylim=c(-20,20))\nlines( window(filtro$f,start=c(1920,12)), lty=2,lwd = 2)\n\n# medidas para o intervalo de previsão\nmedia_prev <- previsao24$f\nmedia_prev <- ts(media_prev, start = c(1940,1), frequency = 12)\n\ndesv_prev <- sqrt( unlist( previsao24$Q))\ndesv_prev <- ts(desv_prev, start = c(1940,1), frequency = 12)\n\n# intervalo de 90% para as previsões\nlines(media_prev, lwd = 2, col ='blue')\nlines(media_prev -1.64*desv_prev, lwd = 2, col ='blue')\nlines(media_prev+1.64*desv_prev, lwd = 2, col ='blue')\n\n# legenda\nlegend('bottomleft',c('Série observada','Previsão 1 passo à frente', 'Previsão de 24 meses'), lty=c(1,2,1), col =c(1,1,'blue'), bty = 'n')\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nAgora vamos estudar os estados suavizados. `\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuave <- dlmSmooth(filtro)\nsd <- sdSmooth(suave)\n```\n:::\n\n\nComo o período é 12, existem $p-1=11$ estados nesse modelo. Contudo, a matriz $G_t$ é construída de modo que o primeiro estado sempre contém o fator sazonal da vez. Portanto, para poder analizar os fatores sazonais suavizados, basta selecionar a primeira coluna de `s` dentro do objeto `suave`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnivel_medio <- suave$s[,1]\nsd_nivel <- sd[,1]\n\nts.plot(dnottem)\nlines(nivel_medio, lwd = 2, col = 'seagreen')\n\n# intervalor de credibilidade (95%) para o nível\nlines(nivel_medio - 1.96*sd_nivel, lwd = 2, col = 'seagreen', lty= 2)\nlines(nivel_medio + 1.96*sd_nivel, lwd = 2, col = 'seagreen', lty=2)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n## Exercícios\n",
    "supporting": [
      "sazonal_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}