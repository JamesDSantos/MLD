{
  "hash": "64ffb98e47924b1aebc65e678c1acdd4",
  "result": {
    "engine": "knitr",
    "markdown": "# Modelos lineares dinâmicos sazonais\n\n\n\n\n\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stderr}\n\n```\nCarregando pacotes exigidos: dlm\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n## A soma de um ciclo sazonal\n\nComo ilustração, considere um efeito sazonal trimestral (período 4). Considere os seguintes fatores sazonais:\n\n$$\\beta_t=\\left\\{\\begin{array}{ll}1,& t=1,5,9,\\ldots \\\\\n2,& t=2,6,10,\\ldots\\\\\n3,&t=3,7,11,\\ldots \\\\\n4,&t=4,8,12,\\ldots\\end{array}\\right.$$\n\nNote que \n$$\\beta_1+\\beta_2+\\beta_3+\\beta_4=10$$\n\nTambém note que\n$$\\beta_2+\\beta_3+\\beta_4+\\beta_5=10$$\ne que o mesmo é verdade para a soma de 4 quaiquer fatores sazonais consecutivos. Pode-se provar que, para qualquer sinal sazonal, a soma de seu efeito considerando um intervalo de tempo igual ao período é constante.\n\nConsidere então que uma série com período 4, fatores sazonais desconhecidos e e uma uma tendência, do tipo\n$$\\hbox{tendência}(t)=\\alpha+\\gamma t.$$\nEntão, para qualquer $k=0,1,2,\\ldots,$\n\n$$y_{k+1}+y_{k+2}+y_{k+3}+y_{k+4}=4\\alpha+\\gamma(10+4k)+\\beta_1+\\beta_2+\\beta_3+\\beta_4$$\n\nPortanto, se os dados forem agregados para construir uma série anual, é impossível estimar $\\alpha$ e $\\beta_1+\\beta_2+\\beta_3+\\beta_4$ em separado. Por isso, assuminos que a soma dos fatores sazonais deve ser nula. Intuitivamente, estamos dizendo que o nível da série não pode ser modelado pela tendência.\n\n## O modelo linear dinâmico para fatores sazonais\n\nConsidere uma série sazonal com período $p$. No modelo linear dinâmico para fatores sazonais, assumimos que existem $p-1$ fatores sazonais,\n\n$$\\psi_1,\\ldots,\\psi_{p-1},$$\nsendo que o $p$-ésimo fator é, necessariamente $-(\\psi_1-\\psi_2-\\cdots-\\psi_{p-1}$. Além disso, permitimos que cada fator evolua no tempo, o que implica na notação $\\psi_t$. Contudo, neste modelo consideramos apenas uma evolução de nível para os fatores (em um problema mensal, todos os janeiros estariam flutuando em torno de um nível, por exemplo). Por este motivo, a previsão para cada fator dentro dentro de uma determinada posição do ciclo sazonal será constante.\n\nA função `dlmModSeas` constrói as matrizes $F_t$ e $G_t$ para o modelo com fatores sazonais dinâmicos. Vamos ilustrar o uso deste modelo utilizando a série `nottem` - por didática, vamos remover a tendência da série via `loess`.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntempo <- 1:length(nottem)\ndnottem <- nottem - loess( nottem ~ tempo)$fit\nts.plot(dnottem)\nabline(h=0,lty =2)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nJá identificamos, em outro momento, que o período desta série é 12, logo\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- dlmModSeas(12)\n```\n:::\n\n\n\n\n\n\n\n\nPrecisamos colocar uma informação sobre os fatores sazonais. Vamos simplesmente assumir que todos valem zero.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod$m0 <- rep(0,11)\n```\n:::\n\n\n\n\n\n\n\n\nVamos estimar as variâncias:\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- modFim(dnottem, mod)\n```\n:::\n\n\n\n\n\n\n\nEm seguida, aplicamos o filtro de Kalman e verificamos os erros de previsão:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfiltro <- dlmFilter(dnottem, mod)\n\nerro <- dnottem - filtro$f\nts.plot(erro)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\nacf(erro)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-6-2.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nPodemos notar que os erros foram altos no começo da série. Em geral, precisamos de pelos menos dois ciclos sazonais para ter uma previsão melhor. Já no correlograma, sobraram alguns elementos para serem explicados, como uma relação da série com as defasagens 1 e 2 e uma sazonalidade autoregressiva. Contudo, o comportamento sazonal, que era nosso objetivo, foi bem explicado.\n\nAs previsões vão se repetir após $12$ unidades de tempo. Abaixo, fazemos a previsão para 2 anos.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprevisao24 <- dlmForecast(filtro,24)\nprevisao24$f\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n             Jan         Feb         Mar         Apr         May         Jun\n1940  -9.5270342  -9.3875820  -6.5109877  -2.5961825   3.0938313   9.1652476\n1941  -9.5270342  -9.3875820  -6.5109877  -2.5961825   3.0938313   9.1652476\n             Jul         Aug         Sep         Oct         Nov         Dec\n1940  11.7374593  12.0203431   7.9654691  -0.4551335  -4.7023333 -10.8030973\n1941  11.7374593  12.0203431   7.9654691  -0.4551335  -4.7023333 -10.8030973\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nVamos colocar essas informações em um gráfico.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts.plot(dnottem,xlim=c(1920,1942), ylim=c(-20,20))\nlines( window(filtro$f,start=c(1920,12)), lty=2,lwd = 2)\n\n# medidas para o intervalo de previsão\nmedia_prev <- previsao24$f\nmedia_prev <- ts(media_prev, start = c(1940,1), frequency = 12)\n\ndesv_prev <- sqrt( unlist( previsao24$Q))\ndesv_prev <- ts(desv_prev, start = c(1940,1), frequency = 12)\n\n# intervalo de 90% para as previsões\nlines(media_prev, lwd = 2, col ='blue')\nlines(media_prev -1.64*desv_prev, lwd = 2, col ='blue')\nlines(media_prev+1.64*desv_prev, lwd = 2, col ='blue')\n\n# legenda\nlegend('bottomleft',c('Série observada','Previsão 1 passo à frente', 'Previsão de 24 meses'), lty=c(1,2,1), col =c(1,1,'blue'), bty = 'n')\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nAgora vamos estudar os estados suavizados. `\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuave <- dlmSmooth(filtro)\nsd <- sdSmooth(suave)\n```\n:::\n\n\n\n\n\n\n\n\nComo o período é 12, existem $p-1=11$ estados nesse modelo. Contudo, a matriz $G_t$ é construída de modo que o primeiro estado sempre contém o fator sazonal da vez. Portanto, para poder analizar os fatores sazonais suavizados, basta selecionar a primeira coluna de `s` dentro do objeto `suave`\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnivel_medio <- suave$s[,1]\nsd_nivel <- sd[,1]\n\nts.plot(dnottem)\nlines(nivel_medio, lwd = 2, col = 'seagreen')\n\n# intervalor de credibilidade (95%) para o nível\nlines(nivel_medio - 1.96*sd_nivel, lwd = 2, col = 'seagreen', lty= 2)\nlines(nivel_medio + 1.96*sd_nivel, lwd = 2, col = 'seagreen', lty=2)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n## Regressão harmônica dinâmica\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nVimos anteriormente que uma onda, de período $p$, pode ser representada pela função harmônica\n\n$$g_1(t)=A_1\\cos\\left(\\frac{2\\pi}{p}t+\\phi_1\\right).$$\nAcontece que é possível que existam outros ciclos dentro do de duração $p$.\n\nPara ilustrar, vamos imaginar o caso no qual $p=12$. Então, temos uma onda se reinicia a cada $12$ meses, isto é,\n\n$$g_1(t)=A_1\\cos\\left(\\frac{2\\pi}{12}t+\\phi_1\\right).$$\nAcontece que é possível que existam\nPorém podemos ter um outro efeito, que se renova a cada semestre. Nesse caso, teríamos outro harmônico para esse comportamento\n\n$$g_2(t)=A_2\\cos\\left(\\frac{2\\pi}{6}t+\\phi_2\\right)$$\n\nTambém podemos ter um ciclo se repetindo a cada quatrimestre\n\n$$g_3(t)=A_3\\cos\\left(\\frac{2\\pi}{4}t+\\phi_3\\right),$$\ne outro a cada trimestre\n\n$$g_4(t)=A_4\\cos\\left(\\frac{2\\pi}{3}t+\\phi_4\\right).$$\n\nEntão, o nosso padrão sazonal seria a soma desses harmônicos:\n\n$$g(t)=\\sum_{j=1}^4 g_{j}(t)=\\sum_{j=1}^4 A_j\\cos\\left(\\frac{2\\pi}{p}jt+\\phi_j\\right).$$\nA função $g_j(t)$ é denominada $j$-ésimo harmônico e é possível ter $q$ harmônicos, onde $q$ é  a parte inteira de $p/2$.\n\nA figura abaixo ilustra essa ideia.\n\n\n\n\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nNo caso geral, para um período $p$, podemos converter o modelo acima em um modelo linear\n\n$$g(t)=\\sum_{j=1}^{q} \\beta_{1,j}\\cos\\left(\\frac{2\\pi}{p}jt\\right)+\\beta_{2,j}\\sin\\left(\\frac{2\\pi}{p}jt\\right).$$\nDe fato, existe $\\boldsymbol{F}_t'$ tal que \n\n$$g(t)=\\boldsymbol{F}_t'\\boldsymbol{\\beta},$$\nonde $\\boldsymbol{\\beta}$ é um vetor contendo $\\beta_{1,1},\\beta_{1,2},\\ldots,\\beta_{1,q},\\beta_{2,q}$. O modelo\n\n$$y_t= \\boldsymbol{F}_t'\\boldsymbol{\\beta}+\\varepsilon_t$$\né denominado regressão harmônica. Assumindo que o vetor de parâmetros pode evoluir no tempo $t$, considerando uma estrutura de nível, teremos o modelo de regressão harmônica dinâmico.\n\nVamos analisar a série `dnottem` utilizando esse modelo com apenas um harmônico. A função `dlmModTrig(p,q)` cria as matrizes necessárias para o modelo de regressão harmônica com período $p$ e $q$ harmônicos (se omitido, serão utilizados $p/2$ harmônicos). \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- dlmModTrig(12, 1)\nmod <- modFim( dnottem, mod)\n```\n:::\n\n\n\n\n\n\n\nVamos aplicar o filtro de Kalman:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfiltro <- dlmFilter(dnottem,mod)\n```\n:::\n\n\n\n\n\n\n\n\nA previsão é semelhante ao que já fizemos, então vamos apenas analisar os erros de previsão.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nerros <- dnottem - filtro$f\nts.plot(erros)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n\n```{.r .cell-code}\nacf(erros)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-14-2.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\nNote que o padrão sazonal não foi todo explicado. Abaixo utilizamos a função periodograma nos erros de previsão.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperiodograma(erros)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPeríodo:  6 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nNote que o período encontrado é 6 - isso corresponde ao harmônico 2, uma vez que 12/2=6. Vamos reescrever nosso modelo colocando os dois primeiros harmônicos.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- dlmModTrig(12, 2)\nmod <- modFim( dnottem, mod)\nfiltro <- dlmFilter(dnottem,mod)\nerros <- dnottem - filtro$f\nts.plot(erros)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n\n```{.r .cell-code}\nacf(erros)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-16-2.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nAgora toda a parte sazonal foi explicada. Isso implica que existem dois comportamentos: um ciclo sazonal com duração de 12 meses e outro com duração de 6 meses.\n\nA amplitude é sem dúvidas uma medida importante, uma vez que ela mede a magnitude do harmônico. Vamos obter as estimativas suavizadas das duas amplitudes.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuave <- dlmSmooth(filtro)\n```\n:::\n\n\n\n\n\n\n\n\nEm `suave$s`, obtemos as estimativas suavizadas para os estados da regressão harmônica. São quatro colunas, sendo que as duas primeiras são referentes ao harmônico 1 e as duas seguinda ao 2. Vamos recuperar as amplitudes:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nA1 <- sqrt( suave$s[,1]^2 + suave$s[,2]^2 )\nA2 <- sqrt( suave$s[,3]^2 + suave$s[,4]^2 )\n\nplot.ts( cbind(A1, A2), lwd = 2)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nPodemos perceber que houve um leve aumento do nível da amplitude do efeito sazonal anual, indo de 10 para 12 unidades, entre 1920 e 1934 (série A1). Já o efeito semestral, com influência bem menor, apresentou padrões de tendência crescente e decrescente ao longo do tempo.\n\n## A superposição de modelos lineares dinâmicos\n\nPodemos imaginar que uma série temporal $y_t$ é a soma de várias séries ocultas. Por exemplo, considere que \n\n$y_t=x_t+u_t$\n\nonde $x_t$ é uma série que possui apenas a tendência da série e $u_t$ a parte sazonal.\n\n<div class='alert alert-success'>\n<strong>Teorema.</strong> Se $x_t$ e $u_t$ são modelos lineares dinâmicos, então $y_t$ também é um modelo linear dinâmico.\n</div>\n\nDeste modo, podemos somar modelos lineares dinâmicos para analizar diferentes tipos de sinal.\n\nConsidere a série `ldeaths`, que já sabemos possuir uma leve tendência linear de decrescimento e um forte sinal sazonal de período 12. Podemos ajustar um modelo linear dinâmico com essas duas características.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- dlmModPoly(2) + dlmModSeas(12)\nmod$m0[1] <- ldeaths[1]\nmod <- modFim(ldeaths, mod)\n\nfiltro <- dlmFilter(ldeaths, mod)\nerro <- ldeaths - filtro$f\n\nts.plot(erro)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n\n```{.r .cell-code}\nacf(erro)\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-19-2.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nOs gráficos acima apontam que os sinais de tendêcia e sazonalidade estão bem descritos. Vamos fazer a previsão para 12 meses a frente:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprevisao12 <- dlmForecast(filtro, 12)\n\nts.plot(ldeaths,xlim=c(1974,1981), ylim=c(-400,4000))\nlines( window(filtro$f,start=c(1974,1)), lty=2,lwd = 2)\n\n# medidas para o intervalo de previsão\nmedia_prev <- previsao12$f\nmedia_prev <- ts(media_prev, start = c(1980,1), frequency = 12)\n\ndesv_prev <- sqrt( unlist( previsao12$Q))\ndesv_prev <- ts(desv_prev, start = c(1980,1), frequency = 12)\n\n# intervalo de 90% para as previsões\nlines(media_prev, lwd = 2, col ='blue')\nlines(media_prev -1.64*desv_prev, lwd = 2, col ='blue')\nlines(media_prev+1.64*desv_prev, lwd = 2, col ='blue')\n\n# legenda\nlegend('bottomleft',c('Série observada','Previsão 1 passo à frente', 'Previsão de 24 meses'), lty=c(1,2,1), col =c(1,1,'blue'), bty = 'n')\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nTambém podemos estudar os elementos suavisados dos sinais:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuave <- dlmSmooth(filtro)\nsd <- sdSmooth(suave)\n\nNível <- suave$s[,1]\n`Inc. tend` <- suave$s[,2]\n`Fat. Saz` <- suave$s[,3]\n\nplot.ts(cbind(Nível, `Inc. tend`,`Fat. Saz`), main = 'Componentes do sinal')\n```\n\n::: {.cell-output-display}\n![](sazonal_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n## Exercícios\n\n<div class='alert alert-warning'>\n<strong>Exercício 2</strong>\n\nAnalise as seguintes séries temporais:\n\n* Óbitos maternos\n\n* Número de nascidos vivos\n\n* `co2`\n\n* Taxa de desemprego\n\n</div>\n\n<div class='alert alert-warning'>\nAnalise as seguintes séries temporais:\n<strong>Exercício 2</strong>\nCompare a tendência e sazonalidade do número de nascidos vivos segundo os partos normal e cesário.\n</div>\n",
    "supporting": [
      "sazonal_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}