{
  "hash": "4c767ac7477004cf94bf6a31d2683862",
  "result": {
    "engine": "knitr",
    "markdown": "# Mais ferramentas exploratórias\n\n## Estudo da tendência utilizando o `loess`\n\n*Loes* é um modelo de regressão não linear não paramétrico. Abaixo mostramos como utilizá-lo considerando um banco de dados com diversas marcas de veículos e a relação entre a variável milhas por galão (mpg) e deslocamento (disp) \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot( mtcars$disp, mtcars$mpg )\nlw <- loess( mpg ~ disp, data = mtcars )\npoints(mtcars$disp, lw$fitted, col = 'tomato', lwd = 2)\nlegend('topright', c('Observado','Ajustado'),fill=c(1,'tomato'), bty='n')\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-1-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n\nPodemos estimar a tendência utilizando o loess, imaginando uma regressão do tipo:\n\n$$E(X_t)=g(t),$$\nou seja, utilizando o tempo como regressora. Vamos ilustrar a ideia utilizando a série de acidentes aéreos mensais da FAB.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# criando a variável regressora\ntempo <- 1 : length(fab_mes)\n\n# aplicando o loess\nlw <- loess( fab_mes ~ tempo)\n\n# transformando o valor predito em uma série temporal\n\nfit <- ts(lw$fitted, start = start(fab_mes), frequency = frequency(fab_mes) )\n\n# gráfico da tendência estimada\n\nts.plot( fab_mes, ylab = 'No. acidentes/mês' , lwd = 2)\nlines(fit, lwd = 2, col = 'tomato')\nlegend('bottomright', c('Observado','Ajustado'),fill=c(1,'tomato'), bty='n')\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-3-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n\n\nAcima estimamos a tendência. Denomine este sinal estimado por $\\hat{g}(t)$. Agora, considere a série\n\n$$y_t=x_t-\\hat{g}(t).$$\nAo analisar esta série, duas coisas podem acontecer:\n\n- Vamos encontrar um comportamento semelhante a um ruído (correlograma com barras praticamente nulas)\n\n- Vamos encontrar algum outro sinal ainda não ajustado.\n\nOs gráficos abaixo mostram que não há mais sinais para procurar\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyt <- fab_mes - fit\n\nts.plot(yt)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-4-1.pdf){fig-pos='H'}\n:::\n\n```{.r .cell-code}\nacf(yt, lag = 30)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-4-2.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n\nPortanto, esta série pode ser escrita como\n\n$$x_t = \\hbox{tendência}_t+\\varepsilon_t,$$\nonde $\\varepsilon_t$ é um ruído branco.\n\n\nAbaixo, vamos analisar a série de taxa de desemprego mensal, entre março de 2002 e dezembro de 2015.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- 'https://www.dropbox.com/s/rmgymzsic99qawd/desemprego.csv?dl=1'\n\nbanco <- fread(url)\n\ndesemprego<- ts( banco[,'V2',], start = c(2002,3), frequency=12)\n\nts.plot(desemprego, ylab = 'Taxa de desemprego')\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-5-1.pdf){fig-pos='H'}\n:::\n\n```{.r .cell-code}\nacf(desemprego, lag = 30)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-5-2.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n\nÉ possível verificar que há tendência e sazonalidade na série. Vamos estimar a componente de tendência primeiro.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# criando a variável regressora\ntempo <- 1 : length(desemprego)\n\n# aplicando o loess\nlw <- loess( desemprego ~ tempo)\n\n# transformando o valor predito em uma série temporal\n\nfit <- ts(lw$fitted, start = start(desemprego), frequency = frequency(desemprego) )\n\n# gráfico da tendência estimada\n\nts.plot( desemprego, ylab = 'Taxa de desemprego' , lwd = 2)\nlines(fit, lwd = 2, col = 'tomato')\nlegend('topright', c('Observado','Ajustado'),fill=c(1,'tomato'), bty='n')\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-6-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n\nVamos eliminar a tendência estiamada e avaliar o restante.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyt <- desemprego - fit\n\nts.plot(yt)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-7-1.pdf){fig-pos='H'}\n:::\n\n```{.r .cell-code}\nacf(yt, lag = 50)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-7-2.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n\nFica claro o comportamento sazonal. Note que o período não parece ser anual, mas sim de 3  em 3 anos. Vamos avaliar esse aspecto com mais detalhes na próxima seção.\n\n\n### Exercícios\n\n<div class='alert alert-warning'>\n<strong>Exercício 1</strong>\nConsiderando o banco de dados sobre suicídios no Mato Grosso do Sul:\n\n1. Estime a tendência\n\n2. Remova a tendência estimada e verifique se o resultado é um ruído branco\n</div>\n\n<div class='alert alert-warning'>\n<strong>Exercício 2</strong> Verifique se há tendência na série `ldeaths`.\n</div>\n\n<div class='alert alert-warning'>\n<strong>Exercício 3</strong> Verifique se há tendência na série de óbitos maternos, cuja url é\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- 'https://drive.google.com/uc?authuser=0&id=1tYFFT9L2iopKmBDUI3P8qNIRaOnMYj7d&export=download'\n```\n:::\n\n\n\n\n\n\n\n\nFaça duas análises, uma com a série inteira e outra eliminando os dados a partir de 2020.\n</div>\n\n<div class='alert alert-warning'>\n<strong>Exercício 4.</strong> O banco de dados abaixo apresenta algumas séries temporais mensais com o número de nascidos vivos em Manaus\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- 'https://drive.google.com/uc?authuser=0&id=139h6x2g7PkAHNTzsbQKUl5G2MqoXYk6Y&export=download'\n```\n:::\n\n\n\n\n\n\n\n\n1. Estime a tendência dos nascimentos considerando duas séries: partos vaginais e cesários. Coloque as duas informações no mesmo gráfico.\n\n2. Elimine a tendência de cada série e verifique se há outro sinal a ser estimado.\n</div>\n\n\n<div class='alert alert-warning'>\n<strong>Exercício 1</strong>\n</div>\n\n\n\n## O periodograma\n\n### Introdução \nTodo padrão sazonal possui um período - a quantidade de tempo necessária para que o padrão se repita. O inverso desse período é denominado frequência fundamental, que é a fração de um ciclo por unidade de tempo.\n\n<div class='alert alert-info'>\n**Exemplo:** Considere o período de 12 meses. Então, a frequência fundamental é 1/12 (ou seja, cada mês representa um doze ávos do período de 1 ano).\n</div>\n\nLembremos que o sinal harmônico é igual a\n$$\\hbox{sinal}(t)=A\\sin\\left(2\\pi\\omega t+\\phi\\right),$$\nonde $\\omega=1/p$ é a frequência. Com um pouco de trigonometria, podemos mostrar que\n\n$$\\hbox{sinal}(t)=\\beta_1\\cos\\left(2\\pi\\omega t\\right)+ \\beta_2\\sin\\left(2\\pi\\omega t\\right)$$\nonde $\\beta_1=A\\cos(\\phi)$ e $\\beta_2=-A\\sin(\\phi)$. É possível mostrar também que $A=\\sqrt{\\beta_1+\\beta_2}$ e $\\phi=\\cos^{-1}(\\beta_1/A)$. A vantagem dessa nova forma é que o sinal pode ser escrito como um modelo linear e pode ser estimado facilmente. A soma de quadrados explicada pela regressão é proporcional à\n\n$$I(\\omega)=\\hat{A}(\\omega)^2 $$\ne podemos mostrar que a estimativa de máxima verossimilhança para $\\omega$ é o valor que maximiza $I(\\omega)$. \n\n<div class='alert alert-success'>\n<strong>Periodograma</strong> O gráfico de $I(\\omega)$ é denominado periodograma. \n</div>\n\nVamos criar a função periodograma\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nIw <- function(y,w){\n\n  # matriz de planetamento\n  n <- length(y)\n  t <- 1:n\n  x <- cbind(cos(2*pi*w*t), sin(2*pi*w*t))\n  \n  # coeficientes do modelo linear\n  beta <- coefficients(lm(y ~x-1))\n  \n  # amplitude\n  A <- sqrt(sum(beta^2))\n  \n  # Iw\n  .5*n*A^2\n}\n\nperiodograma <- function(y){\n  # gráfico\n  n <- length(y)\n  w_detec <- ( 1 : floor(  (n-1)/ 2) ) / n\n  I_w <- sapply( w_detec, function(w) Iw(y , w) )\n  plot( 1 / w_detec , I_w, xlab = 'Período', ylab =     expression(I(w)), type = 'h' , lwd = 2)\n  \n  # encontrando o periodo\n  fund <-  w_detec[ which( I_w == max(I_w))]\n  cat('Período: ',1/fund,'\\n')\n\n}\n```\n:::\n\n\n\n\n\n\n\n\nNa função acima `y` é a série temporal. Vamos aplicar essa função para a série de temperaturas no Castelo de Nottingham.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperiodograma(nottem)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-11-1.pdf){fig-pos='H'}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPeríodo:  12 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n### Periodograma para amostras aleatórias\n\nÉ importante notar que a frequência fundamental é um pico expressivo em relação aos demais. Abaixo mostramos o periodograma para uma amostra aleatória - note como há vários picos, evidenciando a falta de uma frequência fundamental.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperiodograma(rnorm(100))\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-12-1.pdf){fig-pos='H'}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPeríodo:  4.347826 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n### Periodograma na presença de tendência\n\nÉ importante remover a tendência antes de aplicar o periodo. Por exemplo, considere novamente a série `AirPassengers`\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nts.plot(AirPassengers)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-13-1.pdf){fig-pos='H'}\n:::\n\n```{.r .cell-code}\nperiodograma(AirPassengers)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-13-2.pdf){fig-pos='H'}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPeríodo:  144 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nEmbor exista uma sazonalidade clara, o periodograma retorna um período de 12 anos, algo irreal. Vamos remover a tendência.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# criando o loess\ny <- AirPassengers\ntempo <- 1:length(y)\nlw <- loess( y ~ tempo )\nfit <- lw$fitted\n\n# criando a série livre de tendência\ny_detrend <- ts( y-fit, start = start(y), frequency = frequency(y))\n\nts.plot( y_detrend )\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-14-1.pdf){fig-pos='H'}\n:::\n\n```{.r .cell-code}\nperiodograma( y_detrend )\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-14-2.pdf){fig-pos='H'}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPeríodo:  12 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n### Exercícios\n\n<div class='alert alert-warning'>\n<strong>Exercício 1.</strong> Determine o período da série `ldeaths` - número de óbito mensais por doenças pulmonares no Reino Unido.\n</div>\n\n<div class='alert alert-warning'>\n<strong>Exercício 2.</strong> Determine o período da série de óbitos maternos, cuja url é:\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- 'https://drive.google.com/uc?authuser=0&id=1tYFFT9L2iopKmBDUI3P8qNIRaOnMYj7d&export=download'\n```\n:::\n\n\n\n\n\n\n\n</div>\n\n<div class='alert alert-warning'>\n<strong>Exercício 3.</strong> A série `co2` representa a concentração de CO$_2$ na atmosfera medida em Mauna Loa. Analise a tendência da série e estime o período.\n</div>\n\n<div class='alert alert-warning'>\n<strong>Exercício 4.</strong> Determine a tendência e o período da série mensal do número de nascidos vivos em Manaus, independente do tipo de parto. \n</div>\n\n## Ajuste por fatores sazonais\n\nConsidere novamente o harmônico\n\n$$\\hbox{sinal}(t)=A\\cos\\left(\\frac{2\\pi}{p}t+\\phi\\right)$$\n\nO sinal no tempo $t=1+p$ é equivalente ao sinal no tempo 1:\n\n$$\\hbox{sinal}(1+p)=A\\cos\\left(\\frac{2\\pi}{p}+2\\pi+\\phi\\right)=A\\cos\\left(\\frac{2\\pi}{p}+\\phi\\right)=\\hbox{sinal}(1)$$\n\nIsso é verdade para todo $t=1+kp$, onde $k=1,2,\\ldots.$ Isto implica que, na prática, a imagem de $\\hbox{sinal}(t)$ só pode ser $p$ valores:\n\n$$\\hbox{sinal}(t)=\\left\\{\\begin{array}{ll}\\hbox{sinal}(1),&t=1,1+p,1+2p,\\ldots,\\\\\n\\hbox{sinal}(2),&t=2,2+p,2+2p\\ldots,\\\\\n\\vdots,&\\vdots\\\\\n\\hbox{sinal}(p),&t=p,2p,3p\\ldots,\\end{array}\\right.$$\n\nEntão $$x_t=\\hbox{sinal}(t)+\\varepsilon_t$$ pode ser considerado uma ANOVA com um fator.\n\nConsidere a série `ldeths`, que já sabemos ter uma leve tendência decrescente e sazonalidade com período 12. Primeiro, vamos encontrar a série livre de tendência:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntempo <- 1:length(ldeaths)\nlw <- loess( ldeaths ~ tempo)\ntend <- lw$fitted\n\ntend <- ts( tend, start = start(ldeaths), frequency = frequency(ldeaths))\n\n#  série sem tendência\nd_ldeaths <- ldeaths - tend\n```\n:::\n\n\n\n\n\n\n\n\nEm seguida, encontramos o período.\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nperiodograma(d_ldeaths)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-17-1.pdf){fig-pos='H'}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPeríodo:  12 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nNesse momento, devemos atribuir o período para o objeto `ts`, fazendo\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd_ldeaths <- ts( d_ldeaths, frequency= 12) \n```\n:::\n\n\n\n\n\n\n\nNote que o código acima foi inócuo porque o objeto `ldeaths` já tinha o período 12.\n\nAntes de fazer o ajuste sazonal, é possível fazer um gráfico com doze séries temporais, uma para cada fator sazonal (no nosso exemplo, uma série só de janeiros, de fevereiros, etc). Mostramos isso a seguir:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmonthplot(d_ldeaths)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-19-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\nNo gráfico acima, a linha horizontal em cada mês representa a média. \n\nAgora, vamos estimar os 12 fatores sazonais. Para isso, vamos utilizar a função `cycle`, que mostra a posição de cada observação dentro do ciclo sazonal. Eis um exemplo de seu funcionamento:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(cycle(d_ldeaths), 14)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec\n1   1   2   3   4   5   6   7   8   9  10  11  12\n2   1   2                                        \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nVamos transformar o resultado do `cycle` em um fator e ajustar uma ANOVA:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nciclo <- as.factor(cycle(d_ldeaths))\nmod <- lm( d_ldeaths ~ciclo-1)\n\nplot(coefficients(mod))\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-21-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n\nPor último, vamos dessazonalizar a série:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsaz_fit <- mod$fitted.values\nresiduo <- d_ldeaths - saz_fit\n\nplot(residuo)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-22-1.pdf){fig-pos='H'}\n:::\n\n```{.r .cell-code}\nacf(residuo, lag = 30)\n```\n\n::: {.cell-output-display}\n![](ferramentas_files/figure-pdf/unnamed-chunk-22-2.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n\n\n\n\n### Exercícios\n\n<div class=='alert alert-warning'>\n<strong>Exercício 1\nSepare os sinais dos ruídos nas seguintes séries temporais:\n\n1. `nottem`\n2. Óbitos maternos\n3. Número de nascidos vivos\n4. Taxa de desemprego\n5. `AirPassangers`\n</div>",
    "supporting": [
      "ferramentas_files\\figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}