{"title":"Modelos lineares dinâmicos sazonais","markdown":{"headingText":"Modelos lineares dinâmicos sazonais","containsRefs":false,"markdown":"\n```{r echo = F}\nrequire(dlm)\n\nmodFim <- function(y,mod){\n\n    ffbs <- dlmGibbsDIG(y, mod = mod, n.sample = 5000,\n                    a.y=1,b.y=100,a.theta=1,b.theta=100,\n                    save.states = FALSE, thin = 0)\n\nv_sim  <- sample(ffbs$dV[-(1:2500)],2500,T)\n\nq <- dim(ffbs$dW)[2]\nw_sim <- NULL\nfor(j in 1:q){\n w_sim <- c(w_sim, mean(sample(ffbs$dW[,j][-(1:2500)],2500,T)))\n}\n# declarando as variâncias na quádrupla\nmod$V <- mean(v_sim)\nmod$W <- diag( w_sim,q)\nreturn(mod)\n}\ndlmErros <- function(filtro, h = 1){\n  mod <- filtro$mod\n  V <- mod$V\n  FF <- mod$FF\n  GG <- mod$GG\n  y <- filtro$y\n  f <- filtro$f\n  n <- length(y)\n  z <- NULL\n  for(i in 1:n){\n    R <-  dlmSvd2var( filtro$U.R[[i]], filtro$D.R[i,])\n   z[i] <- (y[i] - f[i])/sqrt( V + drop(FF %*% R %*% t(FF)))     \n  }\n  qqnorm(z)\n  abline(0,1)\n  sp <- shapiro.test(z[h:n])\n  text(1.5,-2,paste0('Shapiro-Wilk normality test'))\n  text(1.5,-2.5,paste0('p-valor: ', round(sp$p.value,5)))\n  \n}\nsdSmooth <- function(suave){\n  n <- nrow(suave$s)\n  q <- ncol(suave$s)\n  dp <- array(NA_real_, c( n , q))\n  for(i in 1:n){\n    S <- dlmSvd2var(suave$U.S[[i]],suave$D.S[i,])\n    dp[i,] <- sqrt( diag(S))\n  }\n  dp\n}\n```\n\n## A soma de um ciclo sazonal\n\nComo ilustração, considere um efeito sazonal trimestral (período 4). Considere os seguintes fatores sazonais:\n\n$$\\beta_t=\\left\\{\\begin{array}{ll}1,& t=1,5,9,\\ldots \\\\\n2,& t=2,6,10,\\ldots\\\\\n3,&t=3,7,11,\\ldots \\\\\n4,&t=4,8,12,\\ldots\\end{array}\\right.$$\n\nNote que \n$$\\beta_1+\\beta_2+\\beta_3+\\beta_4=10$$\n\nTambém note que\n$$\\beta_2+\\beta_3+\\beta_4+\\beta_5=10$$\ne que o mesmo é verdade para a soma de 4 quaiquer fatores sazonais consecutivos. Pode-se provar que, para qualquer sinal sazonal, a soma de seu efeito considerando um intervalo de tempo igual ao período é constante.\n\nConsidere então que uma série com período 4, fatores sazonais desconhecidos e e uma uma tendência, do tipo\n$$\\hbox{tendência}(t)=\\alpha+\\gamma t.$$\nEntão, para qualquer $k=0,1,2,\\ldots,$\n\n$$y_{k+1}+y_{k+2}+y_{k+3}+y_{k+4}=4\\alpha+\\gamma(10+4k)+\\beta_1+\\beta_2+\\beta_3+\\beta_4$$\n\nPortanto, se os dados forem agregados para construir uma série anual, é impossível estimar $\\alpha$ e $\\beta_1+\\beta_2+\\beta_3+\\beta_4$ em separado. Por isso, assuminos que a soma dos fatores sazonais deve ser nula. Intuitivamente, estamos dizendo que o nível da série não pode ser modelado pela tendência.\n\n## O modelo linear dinâmico para fatores sazonais\n\nConsidere uma série sazonal com período $p$. No modelo linear dinâmico para fatores sazonais, assumimos que existem $p-1$ fatores sazonais,\n\n$$\\psi_1,\\ldots,\\psi_{p-1},$$\nsendo que o $p$-ésimo fator é, necessariamente $-(\\psi_1-\\psi_2-\\cdots-\\psi_{p-1}$. Além disso, permitimos que cada fator evolua no tempo, o que implica na notação $\\psi_t$. Contudo, neste modelo consideramos apenas uma evolução de nível para os fatores (em um problema mensal, todos os janeiros estariam flutuando em torno de um nível, por exemplo). Por este motivo, a previsão para cada fator dentro dentro de uma determinada posição do ciclo sazonal será constante.\n\nA função `dlmModSeas` constrói as matrizes $F_t$ e $G_t$ para o modelo com fatores sazonais dinâmicos. Vamos ilustrar o uso deste modelo utilizando a série `nottem` - por didática, vamos remover a tendência da série via `loess`.\n\n```{r}\ntempo <- 1:length(nottem)\ndnottem <- nottem - loess( nottem ~ tempo)$fit\nts.plot(dnottem)\nabline(h=0,lty =2)\n```\n\nJá identificamos, em outro momento, que o período desta série é 12, logo\n\n```{r}\nmod <- dlmModSeas(12)\n```\n\nPrecisamos colocar uma informação sobre os fatores sazonais. Vamos simplesmente assumir que todos valem zero.\n\n```{r}\nmod$m0 <- rep(0,11)\n```\n\nVamos estimar as variâncias:\n```{r}\nmod <- modFim(dnottem, mod)\n```\nEm seguida, aplicamos o filtro de Kalman e verificamos os erros de previsão:\n\n```{r}\nfiltro <- dlmFilter(dnottem, mod)\n\nerro <- dnottem - filtro$f\nts.plot(erro)\nacf(erro)\n\n```\n\nPodemos notar que os erros foram altos no começo da série. Em geral, precisamos de pelos menos dois ciclos sazonais para ter uma previsão melhor. Já no correlograma, sobraram alguns elementos para serem explicados, como uma relação da série com as defasagens 1 e 2 e uma sazonalidade autoregressiva. Contudo, o comportamento sazonal, que era nosso objetivo, foi bem explicado.\n\nAs previsões vão se repetir após $12$ unidades de tempo. Abaixo, fazemos a previsão para 2 anos.\n\n```{r}\nprevisao24 <- dlmForecast(filtro,24)\nprevisao24$f\n```\n\nVamos colocar essas informações em um gráfico.\n\n```{r}\nts.plot(dnottem,xlim=c(1920,1942), ylim=c(-20,20))\nlines( window(filtro$f,start=c(1920,12)), lty=2,lwd = 2)\n\n# medidas para o intervalo de previsão\nmedia_prev <- previsao24$f\nmedia_prev <- ts(media_prev, start = c(1940,1), frequency = 12)\n\ndesv_prev <- sqrt( unlist( previsao24$Q))\ndesv_prev <- ts(desv_prev, start = c(1940,1), frequency = 12)\n\n# intervalo de 90% para as previsões\nlines(media_prev, lwd = 2, col ='blue')\nlines(media_prev -1.64*desv_prev, lwd = 2, col ='blue')\nlines(media_prev+1.64*desv_prev, lwd = 2, col ='blue')\n\n# legenda\nlegend('bottomleft',c('Série observada','Previsão 1 passo à frente', 'Previsão de 24 meses'), lty=c(1,2,1), col =c(1,1,'blue'), bty = 'n')\n\n```\n\nAgora vamos estudar os estados suavizados. `\n\n```{r}\nsuave <- dlmSmooth(filtro)\nsd <- sdSmooth(suave)\n\n```\n\nComo o período é 12, existem $p-1=11$ estados nesse modelo. Contudo, a matriz $G_t$ é construída de modo que o primeiro estado sempre contém o fator sazonal da vez. Portanto, para poder analizar os fatores sazonais suavizados, basta selecionar a primeira coluna de `s` dentro do objeto `suave`\n\n```{r}\nnivel_medio <- suave$s[,1]\nsd_nivel <- sd[,1]\n\nts.plot(dnottem)\nlines(nivel_medio, lwd = 2, col = 'seagreen')\n\n# intervalor de credibilidade (95%) para o nível\nlines(nivel_medio - 1.96*sd_nivel, lwd = 2, col = 'seagreen', lty= 2)\nlines(nivel_medio + 1.96*sd_nivel, lwd = 2, col = 'seagreen', lty=2)\n\n```\n\n\n## Forma sazonal trigonométrica\n\n\tQuando a sazonalidade, de período $p$, pode ser explicada por uma onda, vimos que podemos empregar o uso dos harmônicos:\n\t$$g_j(t) = A_j\\cos\\left(\\frac{2\\pi j}{p}t + \\phi\\right)=b_{1,j}\\cos\\left(\\frac{2\\pi j}{p}t\\right)+b_{2,j}\\sin\\left(\\frac{2\\pi j}{p}t\\right).$$\n\tonde $j=0,\\ldots,\\lceil p/2 \\rceil $. Note que os fatores sazonais podem ser recuperados. Por exemplo,  o $i$-ésimo fator sazonal é descrito como\n\t\n\t$$\\psi_i = \\sum_{j=0}^{\\lceil p/2 \\rceil} g_j(i)=\\sum_{j=0}^{\\lceil p/2 \\rceil}b_{1,j}\\cos\\left(\\frac{2\\pi j}{p}i\\right)+b_{2,j}\\sin\\left(\\frac{2\\pi j}{p}i\\right)$$\n\n\tDefinindo o número de harmônicos como $q$, onde  $1\\leq q \\leq \\lceil p/2 \\rceil$, procuramos por um modelo que satisfaz\n\t$$y_t= \\sum_{j=1}^q a_{t,j}\\cos\\left(\\frac{2\\pi j}{p}t\\right)+b_{t,j}\\sin\\left(\\frac{2\\pi j}{p}t\\right)+\\nu_t,$$\n\tou seja, que tenha as componentes da regressão harmônica dinâmicas.\n\t\n\tAs amplitudes dinâmicas ($\\alpha_{j,t}$) e as fases ($\\phi_{j,t}$) podem ser recuperadas usando \n\t$$\\alpha_{j,t} = \\sqrt{a_{j,t}^2+b_{j,t}}^2$$\n\te\n\t$$\\phi_{j,t}=\\cos^{-1}\\left(\\frac{a_{j,t}}{\\alpha_{j,t}}\\right)$$\n\n## Exercícios\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"sazonal.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.353","bibliography":["references.bib"],"editor":"visual","theme":"cosmo"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"sazonal.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"block-headings":true,"bibliography":["references.bib"],"editor":"visual","documentclass":"scrreprt"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf"]}