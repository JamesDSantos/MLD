{"title":"Modelo linear dinâmico polinomial","markdown":{"headingText":"Modelo linear dinâmico polinomial","containsRefs":false,"markdown":"\n```{r}\nrequire(dlm)\n\nmodFim <- function(y,mod){\n\n    ffbs <- dlmGibbsDIG(y, mod = mod, n.sample = 5000,\n                    a.y=1,b.y=100,a.theta=1,b.theta=100,\n                    save.states = FALSE, thin = 0)\n\nv_sim  <- sample(ffbs$dV[-(1:2500)],2500,T)\n\nq <- dim(ffbs$dW)[2]\nw_sim <- NULL\nfor(j in 1:q){\n w_sim <- c(w_sim, mean(sample(ffbs$dW[,j][-(1:2500)],2500,T)))\n}\n# declarando as variâncias na quádrupla\nmod$V <- mean(v_sim)\nmod$W <- diag( w_sim,q)\nreturn(mod)\n}\n```\n\nOs modelos linearas dinâmicos polinomiais possuem uma função de previsão polinomial.\n\nOs podemos mais utilizados na prática são os de ordem 1 e 2, também conhecidos como modelo de nível e de tendência linear, respectivamente.\n\n## O modelo de nível\n\nO modelo de ordem 1, também conhecido como modelo de nível, possui função de previsão da forma\n\n$$f_t(h)=m_t,$$ onde $m_t$ é a média da série para o tempo $t$. Esse tipo de modelo é útil para séries temporais que possuem oscilações na média (ou nível) mas sem exibir uma tendência forte.\n\nConsidere, por exemplo, a série com valores anuais das cheias do Rio Nilo entre 1871 e 1970.\n\n```{r}\nNile <- ts(Nile, start =1900)\nts.plot(Nile, lwd = 2)\nacf(Nile, lwd = 2)\n```\n\nÉ possível notar que há autocorrelação na série, mas o correlograma não revela uma tendência forte. Abaixo mostramos a tendência estimada via `loess`.\n\n```{r}\ntempo <- 1:length(Nile)\nlw <- loess( Nile ~ tempo)\ntend <- ts(lw$fitted, start = start(Nile))\n\nts.plot(Nile)\nlines(tend, lwd = 2, col = 'tomato')\n\n```\n\nA tendência estimada via `loess` parece revelar um comportamento inicial de queda e depois meio século de valores oscilando em torno de do nível. Vamos analisar isso utilizando um modelo linear dinâmico para o nível.\n\nPrimeiro, vamos criar um objeto que possui os componentes $F$ e $G$ adequados. Para tanto, basta usar a função `dlmPoly` e escolher a ordem do modelo polinomial.\n\n```{r}\nlibrary(dlm)\nmod <- dlmModPoly( order = 1)\n```\n\nSe você tiver curiosidade, $F$ e $G$ estão guardados em lista, com os nomes `FF` e `GG`\n\nDentro do objeto `mod` há um componente denomina `m0`. Ele é a estimativa do nível antes de 1. Vamos simplesmente dizer que este é igual ao valor observado em 1900\n\n```{r}\nmod$m0 <- Nile[1]\n```\n\nAgora, vamos estimar as variâncias do modelo, para obter $V$ e $W$:\n\n```{r}\nmod <- modFim( Nile, mod)\n```\n\nAgora, vamos aplicar o Teorema de Bayes, através de uma série de atualizações conhecidas como Filtro de Kalman\n\n```{r}\nfiltro <- dlmFilter(Nile, mod)\n```\n\nEm modelos lineares dinâmicos, definimos o erro de previsão por\n\n$$y_t-E(y_t|D_{t-1})=y_t-f_t.$$ Se todos os sinais foram bem ajustados, os erros de previsão possuem comportamento com um ruído branco. O valor de $f_t$ está no objeto `filtro`.\n\n```{r}\nerro <- Nile - filtro$f\nts.plot(erro)\nacf(erro)\n```\n\nAgora, vamos reaplicar o Teorema de Bayes, considerando a amostra toda, para obter a estimativa suavizada do nível.\n\n```{r}\nsuave <- dlmSmooth(filtro)\n\nts.plot(Nile)\nlines( suave$s, lwd = 2, col = 'seagreen')\n```\n\nTambém podemos fazer um intervalo de credibidade para o nível suavizado.\n\n```{r}\nts.plot(Nile)\nlines( suave$s, lwd = 2, col = 'seagreen')\n\n# variâncias da suavização\nvs <- dlmSvd2var(suave$U.S, suave$D.S)\n\n# intervalo de credibilidade\nlines( suave$s - 1.96*sqrt(unlist(vs)) )\nlines( suave$s + 1.96*sqrt(unlist(vs)) )\n```\n\nPodemos fazer previsões com a função\n\n```{r}\nprev <- dlmForecast(filtro, 3)\nprev$f\n```\n\n## O modelo de tendência\n\nO modelo linear dinâmico polinomial de segunda ordem é um modelo de tendência, uma vez que sua função de previsão é\n\n$$f_t(h)=m_{1,t}+m_{2,t}h.$$\n\nAqui, existem dois estados para cada tempo: $\\theta_{1,t}$ e $\\theta_{2,t}$. No tempo $t$, a média a posteriori dos estados possui a seguinte interpretação:\n\n* $m_{1,t}$: é o nível (média) da série no tempo $t$, estimado com todos os dados disponíveis até o tempo $t$\n\n* $m_{2,t}:$ é a inclinação da tendência da série no tempo $t$, estimado com todos os dados disponíveis até o tempo $t$. Em particular, $m_{2,t}>0$ indica tendência de crescimento, enquanto que $m_{2,t}<0$ indica decrescimento.\n\n```{r echo = F}\nlibrary(data.table)\nurl <- 'https://drive.google.com/uc?authuser=0&id=1iYrnwXgmLK07x8b330aD73scOVruZEuz&export=download'\naereo <-  fread(url, encoding = 'Latin-1')\naereo$ocorrencia_dia <- as.Date(aereo$ocorrencia_dia, '%d/%m/%Y')\nfab_dia <- aereo[,'ocorrencia_dia',]\nfab_mes <- fab_dia[, .N, by=.(year(ocorrencia_dia), month(ocorrencia_dia))]\nfab_mes <-fab_mes[ order(year, month ) ]\nfab_mes <- ts( fab_mes[,3], start = c(2013,1), frequency = 12)\n```\n\nVoltemos à série de acidentes aéreos mensais.\n`\n```{r}\nts.plot(fab_mes, ylab = 'No acidentes/mês')\nacf(fab_mes, main='')\n```\n\nVamos construir um modelo linear para a tendência:\n\n```{r}\nrequire(dlm)\nmod <- dlmModPoly(2)\n```\n\nEm seguida, precisamos dar uma informação inicial sobre os estados no tempo $0$ (ou seja, a média do nível e da tendência antes da série ser observada). Um bom começo é supor que $m_{1,0}$ é o valor $y_1$ - o primeiro valor observado. Além disso, é usual iniciar a análise supondo que a tendência é nula.\n\n```{r}\nmod$m0 <- c(fab_mes[1],0)\n```\n\nAgora, vamos estimar a variâncias do modelo:\n\n```{r}\nmod <- modFim(fab_mes, mod)\n```\n\nVamos estimar os parâmetros dos estados via filtro de Kalman.\n\n```{r}\nfiltro <- dlmFilter(fab_mes, mod)\n```\nVamos analisar os erros de previsão.\n\n```{r}\nerros <- fab_mes - filtro$f\nts.plot(erros)\nacf(erros)\n```\n\nAmbos os gráficos acima mostram um comportamento de ruído branco. \n\nPodemos fazer previsões mais longas com este modelo. Abaixo vamos prever o número de acidentes para os próximos 12 meses.\n\n```{r}\nprevisao12 <- dlmForecast(filtro,12)\nprevisao12$f\n```\n\nVamos colocar essas informações em um gráfico. Vamos começar com as previsões um passo a frente, que são utilizadas para o cálculo do erro de previsão e queforam realizadas dentro do filtro de Kalman - notem que vamos começar as previsões em março, uma vez que as outras foram irreais). Em seguida, vamos apresentar as previsões com um intervalo de 90% de predição (não se usa 95% para previsões porque os intervalos em geral são grandes demais)\n\n```{r}\nts.plot(fab_mes,xlim=c(2013,2025), ylab='No. acidentes mensais', ylim=c(0,75))\nlines( window(filtro$f,start=c(2013,3)), lty=2,lwd = 2)\n\n# medidas para o intervalo de previsão\nmedia_prev <- previsao12$f\nmedia_prev <- ts(media_prev, start = c(2023,7), frequency = 12)\n\ndesv_prev <- sqrt( unlist( previsao12$Q))\ndesv_prev <- ts(desv_prev, start = c(2023,7), frequency = 12)\n\n# intervalo de 90% para as previsões\nlines(media_prev, lwd = 2, col ='blue')\nlines(media_prev -1.64*desv_prev, lwd = 2, col ='blue')\nlines(media_prev+1.64*desv_prev, lwd = 2, col ='blue')\n\n# legenda\nlegend('bottomleft',c('Série observada','Previsão 1 passo à frente', 'Previsão de 12 meses'), lty=c(1,2,1), col =c(1,1,'blue'), bty = 'n')\n\n```\n\nAgora vamos estudar os estados suavizados. `\n\n```{r}\nsuave <- dlmSmooth(filtro)\n```\n\nA obtenção das variâncias é mais delicada. Em cada instante de tempo, é calculada a matriz \n\n$$S_t=\\left( \\begin{array}{cc} s_{11,t} & s_{12,t}\\\\s_{12,t}&s_{22,t}\\end{array}\\right),$$\nque reprenta em sua diagonal a variância dos estados e fora dela a covariância entre eles. Por motivos computacionais, a matriz $S_t$ não é computada diretamente, mas sim duas matrizes $U_t$ e $D_t$ tais que\n\n$$S_t=U_t D_t U_t'$$\nEssa decomposição, conhecida como espectral, possui vantagens numéricas que facilitam o processo de inversão necessário no filtro de Kalman. A função abaixo recupera o desvio padrão a partir de $U_t$ e $D_t$.\n\n```{r}\nsdSmooth <- function(suave){\n  n <- nrow(suave$s)\n  q <- ncol(suave$s)\n  dp <- array(NA_real_, c( n , q))\n  for(i in 1:n){\n    S <- dlmSvd2var(suave$U.S[[i]],suave$D.S[i,])\n    dp[i,] <- sqrt( diag(S))\n  }\n  dp\n}\n```\n\nAbaixo, vamos obter os desvios da suavização\n\n```{r}\nsd <- sdSmooth(suave)\n```\n\n\nVamos começar a análise com o nível. Observe que, como são 2 estados, devemos selecionar a coluna 1.\n\n```{r}\nnivel_medio <- suave$s[,1]\nsd_nivel <- sd[,1]\n\nts.plot(fab_mes)\nlines(nivel_medio, lwd = 2, col = 'seagreen')\n\n# intervalor de credibilidade (95%) para o nível\nlines(nivel_medio - 1.96*sd_nivel, lwd = 2, col = 'seagreen', lty= 2)\nlines(nivel_medio + 1.96*sd_nivel, lwd = 2, col = 'seagreen', lty=2)\n\n```\n\nPor último, vamos analisar a inclinação da tendência. Como a média da série já foi modelada pelo nível, os gráficos das demais componentes não são colocados sobre a série original. Abaixo mostramos o gráfico da inclinação, com seu respectivo intervalo.\n\n```{r}\ntend <- suave$s[,2]\nsd_tend <- sd[,2]\nts.plot(tend, lwd = 2, ylim=c(-1.5,1), ylab='Inclinação da tendência')\nlines(tend-1.96*sd_tend)\nlines(tend+1.96*sd_tend)\nabline(h=0, lty = 2)\n\n# período de mudança da tendência de decrescente para crescente\nabline(v=2016+10/12, lty = 2)\npoints(2016+10/12,0, pch = 15, cex = 1.2)\ntext(2016+11/12,.1,'Oct 16', pos = 2)\n\n# identificando a desaceleração\nx <- window(tend, start=c(2022,7) )\nabline(v=2022+7/12, lty = 2)\npoints(2022+7/12, x[1], pch = 15, cex = 1.2)\ntext(2022+7/12,x[1],'Jul 22', pos = 2)\n\n```\n\nCom o gráfico acima, identificamos muitas características interessantes.\n\n* Note que o zero está presente na maior parte do intervalo. Portanto, podemos apenas afirmar que em certos períodos, a tendência de crescimento/decrescimento foram mais prováveis.\n\n* Em relação à inclinação média,  podemos afirmar que existem evidências de que o padrão de decrescimento estava desacelerando antes de 2016, culminando na inflexão em outubro. Nesse período a série passou a ter uma taxa de crescimento relativamente constante até Julho de 2022, quando começou a desacelar.\n\n## Exercícios\n\n<div class='alert alert-info'>\nAbaixo, mostramos o número de homicídios mensais em Manaus entre Janeiro de 1979 e Dezembro de 2009.\n\n```{r}\nurl <- 'https://www.dropbox.com/s/hcqq6uhgwnimpcn/homicidios_manaus_SIM.csv?dl=1'\n```\n\n* Explore a série.\n\n* Estude o nível da série\n\n* Estude o comportamento da inclinação, identificando possíveis regimes de aceleração/desaceleração de crescimento.\n</div>\n\n<div class='alert alert-info'>\nAnalise a série de suicídios no Mato Grosso do Sul, estudando o nível da série e a inclinação da tendência.\n\n```{r}\nurl <- 'https://drive.google.com/uc?authuser=0&id=1DMSgrQDl0636Lw0Y0MYJHJrgw_2uXntM&export=download'\n```\n</div>\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","output-file":"polinomial.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.353","bibliography":["references.bib"],"editor":"visual","theme":"cosmo"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","output-file":"polinomial.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"block-headings":true,"bibliography":["references.bib"],"editor":"visual","documentclass":"scrreprt"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf"]}